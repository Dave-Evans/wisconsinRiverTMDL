\subsubsection{Soils}
Soils are a critical part of the SWAT modeling framework; they determine many surface hydraulic properties such as runoff and hydraulic conductivity as well as determining the number of HRUs in the basin.   

%Original thinking was that the State Soil Geographic (STATSGO) database coverage would be sufficient for the scale of the WRB. After considering that the elevation and landcover data was at a finer scale than STATSGO and that soils data are available at a finer resolution, it was decided to use the county level soils data, Soil Survey Geographic (SSURGO) database, in the SWAT modeling. %(Are there other issues with STATSGO that justify this decision? Read Mednick and other papers.)  		

The soils data used in the WRB is based on the Soil Survey Geographic (SSURGO) database. This dataset consists of information about the distribution and properties of soils of the US at a scale from 1:12,000 to 1:63,360. The dataset is created and maintained by the USDA-NRCS.\footnote{For more information about SSURGO data see the \href{http://www.nrcs.usda.gov/wps/portal/nrcs/detail/soils/survey/?cid=nrcs142p2_053631}{SSURGO metadata}. }

The soil data configuration for SWAT is conceptualized as consisting of two parts, both involving aggregating soil data to a larger (coarser) scale. The first part is aggregating the soils data to the mapunit level, while the second involves further reducing the number of soil types by aggregating mapunits together.		

There are often several different soil types, usually soil series, mapped within a mapunit and thus it is necessary to combine or aggregate these in order to have a representative soil profile for each mapunit, that is each soil will have data for each of the horizons.\footnote{This process was carried out in the script \href{https://github.com/dnrwaterqualitymodeling/wisconsinRiverTMDL/blob/master/soils/step1_aggregate_gSSURGO.R}{``step1\_aggregate\_gSSURGO.R''.}} There are more than 1500 SSURGO mapunits within the WRB and if all of these were used in SWAT it would result in many tens of thousands of HRUs and so necessitating a very long computing time per model run, complicating the calibration process in which thousands of model runs are necessary. To reduce the number of mapunits further aggregation was necessary.\footnote{This process was carried out in the script \href{https://github.com/dnrwaterqualitymodeling/wisconsinRiverTMDL/blob/master/soils/step2_aggregate_gSSURGO.R}{``step2\_aggregate\_gSSURGO.R''.}}
 
The starting point for aggregating the statewide soils data was the gSSURGO dataset (downloaded on 29 October, 2014). This dataset is intended to be primarily a gridded version of the SSURGO data for a state but also included are the tabular data with soil properties and the vector polygons for all of the soil units from which the gridded data was created. The tabular data representing the components, horizons, and the horizon coarse fragments were joined together so that each component had the data necessary for the SWAT model; these properties were hydrologic soils group, albedo, horizon depths, bulk density, available water capacity, organic matter, saturated conductivity, total percentage of clay, silt and sand, K factor, electrical conductivity, calcium carbonate concentrations, pH (1 to 1 in water), and coarse fragment percentage. Of these, hydrologic soil group and albedo were given at the component level, while the others were given for each horizon.  For all of these properties the representative value given by SSURGO was used. 

Several changes were made to the dataset before aggregation, in order to facilitate processing. Soil organic carbon content is required by SWAT, but is given by SSURGO as soil organic matter. The organic matter value given in SSURGO was converted to an organic carbon value by multiplying by the average carbon content of soil organic matter, 50\% \citep{brady_elements_2004}. The hydrologic soil group (HSG) is denoted as a letter in SSURGO, either A through D, or if the soil has different characteristics when drained, as two letters, A/D, B/D or C/D, the latter of which is the natural state of the soil if not artificially drained (e.g., through tiling or ditching) while the former is if the soil is drained. In order to average the different components it was necessary to convert these letters into numbers, which, considering that the A through D naming scheme corresponds to increasingly wetter drainage conditions, was accomplished by changing the groups from A through D to 1 through 4. Once a number was obtained for the HSG, it was treated as any other soil property in the aggregation process and then rounded to the nearest integer and converted in the same manner to a letter once the aggregation was finished. 

For those components with dual HSGs it was necessary to determine if that area was drained or not. Landuse analysis was conducted in which the soil mapunit polygons with dual HSGs were overlaid on the WRB landuse dataset. If more than half of the area in the mapunit was agriculture then it was assumed that the land was drained and the first HSG taken; conversely, if the landuse was not majority agriculture then it was assumed to not be drained and the `D' was chosen.

The method of \citet{beaudette_algorithms_2013} was used to aggregate multiple components within a mapunit. This method combines soil profile data by splicing the profiles into many thin slices and combining these slices together by a user-defined function. This aggregation methodology was used by \citet{gatzke_aggregation_2011} to aggregate SSURGO data for a SWAT hydrology study in California. The algorithm is implemented as the \texttt{slab} function in the aqp package in the R language and environment and fully described in \citet{beaudette_algorithms_2013}. We used this algorithm to apply a depth weighted average to each horizon, while also weighting the percent composition of each component. This achieved a robust average of the soil properties for each horizon, while also accounting for differing compositions of each component. The depth and number of horizons of the aggregated soil profile produced by this algorithm must be specified before processing. The depth was calculated by using the weighted mean of the depths of the components, with the weights equal to the percent composition of each component. As the number of horizons was not seen to matter as much as the maximum depth, an arbitrary number of five horizons was chosen for the aggregation algorithm. 

The aggregation algorithm was not used on every mapunit. It was not necessary to aggregate mapunits with only one component. Additionally, the algorithm requires information on the horizon depths and so could not be applied to those mapunits without this information. Mapunits without this information included water bodies, urban land, landfills, and other miscellaneous disturbed areas. 

Using the above aggregation method 48,585 individual soil components were aggregated to 1,603 mapunits. Because the hydrologic response unit (HRU) used in SWAT	is derived using unique combinations of land use, slope and soil types, this number of soil mapunits is still too many for efficient computation  and so the second step of the soils data configuration was necessary to further reduce the number of soil types. %\textbf{[More justification necessary?]}

Other researchers have aggregated soil types by their taxonomic class \citep{gatzke_aggregation_2011} but Soil Taxonomy, the soil classification system of the US, classifies largely based on soil morphology and not necessarily on relevant properties. We decided that the most relevant soils information to SWAT is hydrology data, specifically the hydrologic soil group (HSG), which has a large impact on the curve number calculation. With this consideration, aggregation was based around (and so preserved) the HSG of the mapunit. Groups of the same HSG were divided into smaller groups, hereafter known as clusters, of homogeneous soil properties, using a clustering algorithm. The mapunits within each of these clusters were then averaged together to create an average profile for that homogeneous set of soils. These averages were then used as the soil types for the HRU definitions and the SWAT modeling.

Each mapunit was placed into one of four groups according to its hydrologic soil group, A, B, C or D. To subdivide these groups further, a clustering algorithm was used to objectively and robustly create clusters of mapunits with homogeneous soil properties. For this purpose we used Gaussian mixture models to assign mapunits to clusters. The mixture model algorithm we used was the \texttt{Mclust} function in the mclust package \citep{fraley_mclust_2012} in R. A mixture model is a probabilistic model for representing the presence of subpopulations within an overall population. In our case, the overall population would be the group of mapunits of like hydrologic soil groups (say all mapunits with an HSG of A), while the (unknown) subpopulations are the clusters of mapunits with similar distributions of soil properties (such as a cluster of sandier soils, shallow soils or slow saturated conductivity). Using the default settings of the function, the algorithm clustered all of the A HSG mapunits into 6 clusters, and all of the other HSG classes into 9 clusters.   

Each of the 1603 mapunits had data regarding the soil property values at each horizon. In this format it was thought that profile depth would negatively affect the clustering algorithm, e.g., deep soils all clustered together, shallow soils clustered together, causing clusters to be entirely governed by depth. To remedy this issue, depth weighted averages of the horizons were taken to derive one value per soil property for each mapunit; essentially collapsing the soil profile down to one aggregate horizon. Profile depth was still considered in the clustering algorithm by keeping the profile depth as a property and so in this way it is represented but does dominate the clustering algorithm.

Several of the soil property fields of the SSURGO dataset did not seem to be populated or commonly had no data values, these properties were not used in the clustering process so the spurious zeros would not influence the algorithm. These properties were coarse fragments, calcium carbonate, and electrical conductivity.  Further, we believe that several of the soil properties used by SWAT were not as important as others and so these properties were also excluded from the clustering algorithm; these variables were pH and albedo. 

Not every mapunit was included in the clustering procedure. Those mapunits that did not have hydrologic soil group were not included, nor were mapunits that did not have information on the soil properties of the horizons. These included the same miscellaneous mapunits as were excluded from the aggregation algorithm used in aggregating components to the mapunit level: pits, landfills, urban or made land, and rock outcrops. These miscellaneous mapunits were grouped by their non-soil/no-property status. Water polygons were also not included in the clustering analysis.

The same soil profile aggregation algorithm \citep{beaudette_algorithms_2013} used to aggregate several components together in the first part of the configuration was used to combine the soil profiles of a cluster into one composite soil profile. In this implementation each mapunit was given equal weight in the aggregation algorithm. Those mapunits designated as miscellaneous were aggregated into one soil profile as the other clusters were, while the water mapunits were not aggregated. The miscellaneous  grouping was assigned a hydrologic soil group by converting the letter designation into an ordinal integer (that is A, B, C, D to 1, 2, 3, 4) and the average was taken, rounded to the nearest integer, and converted by to the appropriate hydrologic soil group designation, which happened to be B. Following SWAT convention, the water units were given an HSG of D, and assigned an albedo of 0.23, a saturated conductivity of 600.

A total of 35 soil classes were distilled from this process. A sample of the properties are found in table \ref{table:soil_prop}.
\input{./tex/model_setup/soil_property_table.tex}

Soil Phosphorus concentrations were obtained through the University of Wisconsin Soil Testing Laboratory \footnote{For more information visit \href{http://uwlab.soils.wisc.edu/}{uwlab.soils.wisc.edu}}. Soil phosphorus concentrations are aggregated by county by the soil laboratory for each year from 1974 to the present. We chose the annual average soil concentration nearest the beginning of the model spin-up period, 1995, to establish prior concentrations. Subbasin-level soil phosphorus concentrations were estimated by calculating an area-weighted average of intersecting counties within a subbasin. Because the phosphorus samples analyzed at the soils laboratory are strongly bias toward samples on agricultural fields, only agricultural HRUs were given the subbasin average concentration, while non-agricultural HRUs within each subbasin were given the default concentration (5 mg P/kg) and assumed to equilibrate over the 6-year model spin-up period. Soluble phosphorus concentrations were estimated as half of the reported phosphorus using the Bray-1 method measured with a spectrophotometer \citep{vadas_validating_2010}. Organic phosphorus concentrations were estimated by assuming that phosphorus constitues 0.85\% of organic material measured by loss of weight upon ignition (correspondence with Phillip Barak, needs citation).